<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>draco.core.containers &mdash; draco 0+untagged.1.ga138890 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> draco
          </a>
              <div class="version">
                0+untagged.1.ga138890
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev.html">Development Guidelines</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">draco</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>draco.core.containers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for draco.core.containers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Distributed containers for holding various types of analysis data.</span>

<span class="sd">Containers</span>
<span class="sd">==========</span>
<span class="sd">- :py:class:`Map`</span>
<span class="sd">- :py:class:`SiderealStream`</span>
<span class="sd">- :py:class:`SystemSensitivity`</span>
<span class="sd">- :py:class:`RFIMask`</span>
<span class="sd">- :py:class:`TimeStream`</span>
<span class="sd">- :py:class:`GridBeam`</span>
<span class="sd">- :py:class:`TrackBeam`</span>
<span class="sd">- :py:class:`MModes`</span>
<span class="sd">- :py:class:`SVDModes`</span>
<span class="sd">- :py:class:`KLModes`</span>
<span class="sd">- :py:class:`VisGridStream`</span>
<span class="sd">- :py:class:`HybridVisStream`</span>
<span class="sd">- :py:class:`HybridVisMModes`</span>
<span class="sd">- :py:class:`RingMap`</span>
<span class="sd">- :py:class:`RingMapMask`</span>
<span class="sd">- :py:class:`CommonModeGainData`</span>
<span class="sd">- :py:class:`CommonModeSiderealGainData`</span>
<span class="sd">- :py:class:`GainData`</span>
<span class="sd">- :py:class:`SiderealGainData`</span>
<span class="sd">- :py:class:`StaticGainData`</span>
<span class="sd">- :py:class:`DelayCutoff`</span>
<span class="sd">- :py:class:`DelaySpectrum`</span>
<span class="sd">- :py:class:`Powerspectrum2D`</span>
<span class="sd">- :py:class:`SVDSpectrum`</span>
<span class="sd">- :py:class:`FrequencyStack`</span>
<span class="sd">- :py:class:`FrequencyStackByPol`</span>
<span class="sd">- :py:class:`MockFrequencyStack`</span>
<span class="sd">- :py:class:`MockFrequencyStackByPol`</span>
<span class="sd">- :py:class:`SourceCatalog`</span>
<span class="sd">- :py:class:`SpectroscopicCatalog`</span>
<span class="sd">- :py:class:`FormedBeam`</span>
<span class="sd">- :py:class:`FormedBeamHA`</span>
<span class="sd">- :py:class:`FormedBeamMask`</span>
<span class="sd">- :py:class:`FormedBeamHAMask`</span>

<span class="sd">Container Base Classes</span>
<span class="sd">----------------------</span>
<span class="sd">- :py:class:`ContainerBase`</span>
<span class="sd">- :py:class:`TableBase`</span>
<span class="sd">- :py:class:`TODContainer`</span>
<span class="sd">- :py:class:`VisContainer`</span>
<span class="sd">- :py:class:`SampleVarianceContainer`</span>
<span class="sd">- :py:class:`FreqContainer`</span>
<span class="sd">- :py:class:`SiderealContainer`</span>
<span class="sd">- :py:class:`MContainer`</span>

<span class="sd">Helper Routines</span>
<span class="sd">---------------</span>
<span class="sd">These routines are designed to be replaced by other packages trying to insert</span>
<span class="sd">their own custom container types.</span>

<span class="sd">- :py:meth:`empty_like`</span>
<span class="sd">- :py:meth:`empty_timestream`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">caput</span> <span class="kn">import</span> <span class="n">memh5</span><span class="p">,</span> <span class="n">tod</span>

<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">tools</span>

<span class="c1"># Try to import bitshuffle to set the default compression options</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">bitshuffle.h5</span>

    <span class="n">COMPRESSION</span> <span class="o">=</span> <span class="n">bitshuffle</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">H5FILTER</span>
    <span class="n">COMPRESSION_OPTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bitshuffle</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">H5_COMPRESS_LZ4</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">COMPRESSION</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">COMPRESSION_OPTS</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="ContainerBase"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.ContainerBase">[docs]</a><span class="k">class</span> <span class="nc">ContainerBase</span><span class="p">(</span><span class="n">memh5</span><span class="o">.</span><span class="n">BasicCont</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class for pipeline containers.</span>

<span class="sd">    This class is designed to do much of the work of setting up pipeline</span>
<span class="sd">    containers. It should be derived from, and two variables set `_axes` and</span>
<span class="sd">    `_dataset_spec`. See the :ref:`Notes &lt;containerbase_notes&gt;` section for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy axis definitions from. Must be supplied as</span>
<span class="sd">        keyword argument.</span>
<span class="sd">    attrs_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy attributes from. Must be supplied as keyword</span>
<span class="sd">        argument. This applies to attributes in default datasets too.</span>
<span class="sd">    skip_datasets : bool, optional</span>
<span class="sd">        Skip creating datasets. They must all be added manually with</span>
<span class="sd">        `.add_dataset` regardless of the entry in `.dataset_spec`. Default is False.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Should contain entries for all other axes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. _containerbase_notes:</span>

<span class="sd">    Inheritance from other `ContainerBase` subclasses should work as expected,</span>
<span class="sd">    with datasets defined in super classes appearing as expected, and being</span>
<span class="sd">    overridden where they are redefined in the derived class.</span>

<span class="sd">    The variable `_axes` should be a tuple containing the names of axes that</span>
<span class="sd">    datasets in this container will use.</span>

<span class="sd">    The variable `_dataset_spec` should define the datasets. It&#39;s a dictionary</span>
<span class="sd">    with the name of the dataset as key. Each entry should be another</span>
<span class="sd">    dictionary, the entry &#39;axes&#39; is mandatory and should be a list of the axes</span>
<span class="sd">    the dataset has (these should correspond to entries in `_axes`), as is</span>
<span class="sd">    `dtype` which should be a datatype understood by numpy. Other possible</span>
<span class="sd">    entries are:</span>

<span class="sd">    - `initialise` : if set to `True` the dataset will be created as the</span>
<span class="sd">      container is initialised.</span>

<span class="sd">    - `distributed` : the dataset will be distributed if the entry is `True`, if</span>
<span class="sd">      `False` it won&#39;t be, and if not set it will be distributed if the</span>
<span class="sd">      container is set to be.</span>

<span class="sd">    - `distributed_axis` : the axis to distribute over. Should be a name given</span>
<span class="sd">      in the `axes` entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">convert_attribute_strings</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">convert_dataset_strings</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Pull out the values of needed arguments</span>
        <span class="n">axes_from</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;axes_from&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attrs_from</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;attrs_from&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">skip_datasets</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;skip_datasets&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;distributed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;comm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_chunked</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;allow_chunked&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Run base initialiser</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">distributed</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)</span>

        <span class="c1"># Check to see if this call looks like it was called like</span>
        <span class="c1"># memh5.MemDiskGroup would have been. If it is, we&#39;re probably trying to</span>
        <span class="c1"># create a bare container, so don&#39;t initialise any datasets. This</span>
        <span class="c1"># behaviour is needed to support tod.concatenate</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;data_group&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create axis entries</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>

            <span class="n">axis_map</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Check if axis is specified in initialiser</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

                <span class="c1"># If axis is an integer, turn into an arange as a default definition</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">axis_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axis_map</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

            <span class="c1"># If not set in the arguments copy from another object if set</span>
            <span class="k">elif</span> <span class="n">axes_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes_from</span><span class="o">.</span><span class="n">index_map</span><span class="p">:</span>
                <span class="n">axis_map</span> <span class="o">=</span> <span class="n">axes_from</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

            <span class="c1"># Set the index_map[axis] if we have a definition, otherwise throw an error</span>
            <span class="k">if</span> <span class="n">axis_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_index_map</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis_map</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No definition of axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> supplied.&quot;</span><span class="p">)</span>

        <span class="c1"># Iterate over datasets and initialise any that specify it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_datasets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;initialise&quot;</span> <span class="ow">in</span> <span class="n">spec</span> <span class="ow">and</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;initialise&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Copy over attributes</span>
        <span class="k">if</span> <span class="n">attrs_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Copy attributes from container root</span>
            <span class="n">memh5</span><span class="o">.</span><span class="n">copyattrs</span><span class="p">(</span><span class="n">attrs_from</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

            <span class="c1"># Copy attributes over from any common datasets</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrs_from</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                    <span class="n">attrs_no_axis</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_from</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;axis&quot;</span>
                    <span class="p">}</span>
                    <span class="n">memh5</span><span class="o">.</span><span class="n">copyattrs</span><span class="p">(</span><span class="n">attrs_no_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

            <span class="c1"># Make sure that the __memh5_subclass attribute is accurate</span>
            <span class="n">clspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">clsattr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__memh5_subclass&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clsattr</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clsattr</span> <span class="o">!=</span> <span class="n">clspath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;__memh5_subclass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clspath</span>

<div class="viewcode-block" id="ContainerBase.add_dataset"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.ContainerBase.add_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">add_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an empty dataset.</span>

<span class="sd">        The dataset must be defined in the specification for the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of the dataset to create.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dset : `memh5.MemDataset`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Dataset must be specified</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not known.&quot;</span><span class="p">)</span>

        <span class="n">dspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Fetch dataset properties</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">dspec</span><span class="p">[</span><span class="s2">&quot;axes&quot;</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">dspec</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span>
        <span class="n">chunks</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span> <span class="n">compression_opts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_chunked</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chunks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">compression_opts</span> <span class="o">=</span> <span class="n">dspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression_opts&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get distribution properties</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed</span> <span class="ow">and</span> <span class="n">dspec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distributed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>

        <span class="c1"># Check that all the specified axes are defined, and fetch their lengths</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">axis</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Axis </span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2"> not defined in index_map&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>

            <span class="n">shape</span> <span class="o">+=</span> <span class="p">(</span><span class="n">l</span><span class="p">,)</span>

        <span class="c1"># Fetch distributed axis, and turn into axis index</span>
        <span class="n">dist_axis</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dspec</span><span class="p">[</span><span class="s2">&quot;distributed_axis&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;distributed_axis&quot;</span> <span class="ow">in</span> <span class="n">dspec</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dist_axis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dist_axis</span><span class="p">)</span>

        <span class="c1"># Check chunk dimensions are consistent with axis</span>
        <span class="k">if</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_chunks</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">final_chunks</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l</span><span class="p">),)</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">final_chunks</span>

        <span class="c1"># Create dataset</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
            <span class="n">distributed_axis</span><span class="o">=</span><span class="n">dist_axis</span><span class="p">,</span>
            <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
            <span class="n">compression_opts</span><span class="o">=</span><span class="n">compression_opts</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dset</span></div>

    <span class="k">def</span> <span class="nf">_ensure_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure datasets that have chunk/compression specs are chunked.</span>

<span class="sd">        For every dataset, check if chunks and compression are set, and</span>
<span class="sd">        if not set them to dataset_spec values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;chunks&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ensure chunks aren&#39;t larger than dataset shape</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">chunks</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">dset</span><span class="p">][</span><span class="s2">&quot;chunks&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">l</span><span class="p">),)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_storage_root</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;compression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_storage_root</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">dset</span><span class="p">][</span>
                    <span class="s2">&quot;compression&quot;</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;compression_opts&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">compression_opts</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_storage_root</span><span class="p">[</span><span class="n">dset</span><span class="p">]</span><span class="o">.</span><span class="n">compression_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_spec</span><span class="p">[</span>
                    <span class="n">dset</span>
                <span class="p">][</span><span class="s2">&quot;compression_opts&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the datasets in this container.</span>

<span class="sd">        Do not try to add a new dataset by assigning to an item of this</span>
<span class="sd">        property. Use `create_dataset` instead.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        datasets : read only dictionary</span>
<span class="sd">            Entries are :mod:`caput.memh5` datasets.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">memh5</span><span class="o">.</span><span class="n">is_group</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">memh5</span><span class="o">.</span><span class="n">ro_dict</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of the fully resolved dataset specifiction as a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ddict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Iterate over the reversed MRO and look for _table_spec attributes</span>
        <span class="c1"># which get added to a temporary dict. We go over the reversed MRO so</span>
        <span class="c1"># that the `tdict.update` overrides tables in base classes.`</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># NOTE: this is a little ugly as the following line will drop</span>
                <span class="c1"># down to base classes if dataset_spec isn&#39;t present, and thus</span>
                <span class="c1"># try and `update` with the same values again.</span>
                <span class="n">ddict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dataset_spec</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Add in any _dataset_spec found on the instance</span>
        <span class="n">ddict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_dataset_spec&quot;</span><span class="p">,</span> <span class="p">{}))</span>

        <span class="c1"># Ensure that the dataset_spec is the same order on all ranks</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ddict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ddict</span><span class="p">)}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_class_axes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the set of axes defined by the container and it&#39;s base classes.&quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Iterate over the reversed MRO and look for _table_spec attributes</span>
        <span class="c1"># which get added to a temporary dict. We go over the reversed MRO so</span>
        <span class="c1"># that the `tdict.update` overrides tables in base classes.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">cls</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_axes</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># This must be the same order on all ranks, so we need to explicitly sort to get around the</span>
        <span class="c1"># hash randomization</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">axes</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The set of axes for this container including any defined on the instance.&quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_class_axes</span><span class="p">())</span>

        <span class="c1"># Add in any axes found on the instance (this is needed to support the table</span>
        <span class="c1"># classes where</span>
        <span class="c1"># the axes get added at run time)</span>
        <span class="n">axes</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_axes&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># This must be the same order on all ranks, so we need to explicitly sort to</span>
        <span class="c1"># get around the hash randomization</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">axes</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_selections</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sel_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match down-selection arguments to axes of datasets.</span>

<span class="sd">        Parses sel_* argument and returns dict mapping dataset names to selections.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sel_args : dict</span>
<span class="sd">            Should contain valid numpy indexes as values and axis names (str) as keys.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Mapping of dataset names to numpy indexes for downselection of the data.</span>
<span class="sd">            Also includes another dict under the key &quot;index_map&quot; that includes</span>
<span class="sd">            the selections for those.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if all those axes exist</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">sel_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_class_axes</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No &#39;</span><span class="si">{}</span><span class="s2">&#39; axis found to select from.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>

        <span class="c1"># Build selections dict</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_dataset_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ds_axes</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;axes&quot;</span><span class="p">]</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ds_relevant</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ds_axes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">sel_args</span><span class="p">:</span>
                    <span class="n">sel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sel_args</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
                    <span class="n">ds_relevant</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ds_relevant</span><span class="p">:</span>
                <span class="n">selections</span><span class="p">[</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>

        <span class="c1"># add index maps selections</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">sel_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">selections</span><span class="p">[</span><span class="s2">&quot;/index_map/&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span>

        <span class="k">return</span> <span class="n">selections</span>

<div class="viewcode-block" id="ContainerBase.copy"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.ContainerBase.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy this container, optionally sharing the source datasets.</span>

<span class="sd">        This routine will create a copy of the container. By default this is</span>
<span class="sd">        as full copy with the contents fully independent. However, a set of</span>
<span class="sd">        dataset names can be given that will share the same data as the</span>
<span class="sd">        source to save memory for large datasets. These will just view the</span>
<span class="sd">        same memory, so any modification to either the original or the copy</span>
<span class="sd">        will be visible to the other. This includes all write operations,</span>
<span class="sd">        addition and removal of attributes, redistribution etc. This</span>
<span class="sd">        functionality should be used with caution and clearly documented.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shared : list, optional</span>
<span class="sd">            A list of datasets whose content will be shared with the original.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        copy : subclass of ContainerBase</span>
<span class="sd">            The copied container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">attrs_from</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">axes_from</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">skip_datasets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Loop over datasets that exist in the source and either add a view of</span>
        <span class="c1"># the source dataset, or perform a full copy</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">shared</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">shared</span><span class="p">:</span>
                <span class="c1"># TODO: find a way to do this that doesn&#39;t depend on the</span>
                <span class="c1"># internal implementation of BasicCont and MemGroup</span>
                <span class="c1"># NOTE: we don&#39;t use `.view()` on the RHS here as we want to</span>
                <span class="c1"># preserve the shared data through redistributions</span>
                <span class="n">new_cont</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_get_storage</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_get_storage</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="n">new_cont</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Ensure that we have exactly the same distribution</span>
                <span class="k">if</span> <span class="n">dset</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
                    <span class="n">dset</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">distributed_axis</span><span class="p">)</span>

                <span class="c1"># Copy over the data and attributes</span>
                <span class="n">dset</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>
                <span class="n">memh5</span><span class="o">.</span><span class="n">copyattrs</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="c1"># TODO Is there a case where these properties don&#39;t exist?</span>
                <span class="n">data</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">chunks</span>
                <span class="n">data</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">compression</span>
                <span class="n">data</span><span class="o">.</span><span class="n">compression_opts</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">compression_opts</span>

        <span class="k">return</span> <span class="n">new_cont</span></div></div>


<div class="viewcode-block" id="TableBase"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.TableBase">[docs]</a><span class="k">class</span> <span class="nc">TableBase</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class for containers holding tables of data.</span>

<span class="sd">    Similar to the `ContainerBase` class, the container is defined through a</span>
<span class="sd">    dictionary given as a `_table_spec` class attribute. The container may also</span>
<span class="sd">    hold generic datasets by specifying `_dataset_spec` as with `ContainerBase`.</span>
<span class="sd">    See :ref:`Notes &lt;tablebase_notes&gt;` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy axis definitions from. Must be supplied as</span>
<span class="sd">        keyword argument.</span>
<span class="sd">    attrs_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy attributes from. Must be supplied as keyword</span>
<span class="sd">        argument. This applies to attributes in default datasets too.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Should contain definitions for all other table axes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. _tablebase_notes:</span>

<span class="sd">    A `_table_spec` consists of a dictionary mapping table names into a</span>
<span class="sd">    description of the table. That description is another dictionary containing</span>
<span class="sd">    several entries.</span>

<span class="sd">    - `columns` : the set of columns in the table. Given as a list of</span>
<span class="sd">      `(name, dtype)` pairs.</span>

<span class="sd">    - `axis` : an optional name for the rows of the table. This is automatically</span>
<span class="sd">      generated as `&#39;&lt;tablename&gt;_index&#39;` if not explicitly set. This corresponds</span>
<span class="sd">      to an `index_map` entry on the container.</span>

<span class="sd">    - `initialise` : whether to create the table by default.</span>

<span class="sd">    - `distributed` : whether the table is distributed, or common across all MPI ranks.</span>

<span class="sd">    An example `_table_spec` entry is::</span>

<span class="sd">        _table_spec = {</span>
<span class="sd">            &#39;quasars&#39;: {</span>
<span class="sd">                &#39;columns&#39;: [</span>
<span class="sd">                    [&#39;ra&#39;: np.float64],</span>
<span class="sd">                    [&#39;dec&#39;: np.float64],</span>
<span class="sd">                    [&#39;z&#39;: np.float64]</span>
<span class="sd">                ],</span>
<span class="sd">                &#39;distributed&#39;: False,</span>
<span class="sd">                &#39;axis&#39;: &#39;quasar_id&#39;</span>
<span class="sd">            }</span>
<span class="sd">            &#39;quasar_mask&#39;: {</span>
<span class="sd">                &#39;columns&#39;: [</span>
<span class="sd">                    [&#39;mask&#39;, np.bool]</span>
<span class="sd">                ],</span>
<span class="sd">                &#39;axis&#39;: &#39;quasar_id&#39;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_table_spec</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Get the dataset specifiction for this class (not any base classes), or</span>
        <span class="c1"># an empty dictionary if it does not exist. Do the same for the axes entry..</span>
        <span class="n">dspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_dataset_spec&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_axes&quot;</span><span class="p">,</span> <span class="p">())</span>

        <span class="c1"># Iterate over all table_spec entries and construct dataset specifications for</span>
        <span class="c1"># them.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Get the specifieid axis or if not present create a unique one for</span>
            <span class="c1"># this table entry</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;axis&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_index&quot;</span><span class="p">)</span>

            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_dtype</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">])</span>

            <span class="n">_dataset</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">axis</span><span class="p">],</span>
                <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
                <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initialise&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distributed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="n">axis</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">dspec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dataset</span>

            <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">axis</span><span class="p">,)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_spec</span> <span class="o">=</span> <span class="n">dspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="n">axes</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TableBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take a dictionary of columns and turn into the</span>
<span class="sd">        appropriate compound data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">%i</span><span class="s2"> is invalid&quot;</span> <span class="o">%</span> <span class="n">ci</span><span class="p">)</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of the fully resolved table specifiction as a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="n">tdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">tdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_table_spec</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">tdict</span></div>


<div class="viewcode-block" id="TODContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.TODContainer">[docs]</a><span class="k">class</span> <span class="nc">TODContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">,</span> <span class="n">tod</span><span class="o">.</span><span class="n">TOData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pipeline container for time ordered data.</span>

<span class="sd">    This works like a normal :class:`ContainerBase` container, with the added</span>
<span class="sd">    ability to be concatenated, and treated like a a :class:`tod.TOData`</span>
<span class="sd">    instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The actual times associated with each entry of the time axis.</span>

<span class="sd">        By convention this property should return the floating point UTC UNIX time in</span>
<span class="sd">        seconds for the *centre* of each time sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:][</span><span class="s2">&quot;ctime&quot;</span><span class="p">]</span>
        <span class="c1"># Need to check for both types as different numpy versions return</span>
        <span class="c1"># different exceptions.</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span></div>


<div class="viewcode-block" id="VisContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.VisContainer">[docs]</a><span class="k">class</span> <span class="nc">VisContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base container for holding a visibility dataset.</span>

<span class="sd">    This works like a :class:`ContainerBase` container, with the</span>
<span class="sd">    ability to create visibility specific axes, if they are not</span>
<span class="sd">    passed as a kwargs parameter.</span>

<span class="sd">    Additionally this container has visibility specific defined properties</span>
<span class="sd">    such as &#39;vis&#39;, &#39;weight&#39;, &#39;freq&#39;, &#39;input&#39;, &#39;prod&#39;, &#39;stack&#39;,</span>
<span class="sd">    &#39;prodstack&#39;, &#39;conjugate&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy axis definitions from. Must be supplied as</span>
<span class="sd">        keyword argument.</span>
<span class="sd">    attrs_from : `memh5.BasicCont`, optional</span>
<span class="sd">        Another container to copy attributes from. Must be supplied as keyword</span>
<span class="sd">        argument. This applies to attributes in default datasets too.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Should contain entries for all other axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Resolve product map</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;prod&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;axes_from&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;prod&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">):</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span>

        <span class="c1"># Resolve input map</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;axes_from&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

        <span class="c1"># Resolve stack map</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;stack&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;axes_from&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;stack&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">):</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>

        <span class="c1"># Automatically construct product map from inputs if not given</span>
        <span class="k">if</span> <span class="n">prod</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nfeed</span> <span class="o">=</span> <span class="n">inputs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">fi</span><span class="p">,</span> <span class="n">fj</span><span class="p">]</span> <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfeed</span><span class="p">)</span> <span class="k">for</span> <span class="n">fj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">nfeed</span><span class="p">)]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">prod</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u4&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;conjugate&quot;</span><span class="p">,</span> <span class="s2">&quot;u1&quot;</span><span class="p">)])</span>
            <span class="n">stack</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prod</span><span class="p">))</span>
            <span class="n">stack</span><span class="p">[</span><span class="s2">&quot;conjugate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span>

        <span class="c1"># Call initializer from `ContainerBase`</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VisContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">reverse_map_stack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Create reverse map</span>
        <span class="k">if</span> <span class="s2">&quot;reverse_map_stack&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># If axis is an integer, turn into an arange as a default definition</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;reverse_map_stack&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">reverse_map_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;reverse_map_stack&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reverse_map_stack</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;reverse_map_stack&quot;</span><span class="p">]</span>
        <span class="c1"># If not set in the arguments copy from another object if set</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;axes_from&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;stack&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reverse_map</span><span class="p">):</span>
            <span class="n">reverse_map_stack</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axes_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reverse_map</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>

        <span class="c1"># Set the reverse_map[&#39;stack&#39;] if we have a definition,</span>
        <span class="c1"># otherwise do NOT throw an error, errors are thrown in</span>
        <span class="c1"># classes that actually need a reverse stack</span>
        <span class="k">if</span> <span class="n">reverse_map_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_reverse_map</span><span class="p">(</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="n">reverse_map_stack</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The visibility like dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The visibility weights.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis_weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The correlated inputs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All the pairwise products that are represented in the data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The stacks definition as an index (and conjugation) of a member product.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prodstack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A pair of input indices representative of those in the stack.</span>

<span class="sd">        Note, these are correctly conjugated on return, and so calculations</span>
<span class="sd">        of the baseline and polarisation can be done without additionally</span>
<span class="sd">        looking up the stack conjugation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stacked</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">][:][</span><span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">][</span><span class="s2">&quot;prod&quot;</span><span class="p">]]</span>

        <span class="n">prodmap</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">conj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s2">&quot;conjugate&quot;</span><span class="p">]</span>
        <span class="n">prodmap</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conj</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">])</span>
        <span class="n">prodmap</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conj</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">prodmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_stacked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if the data has been stacked or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span></div>


<div class="viewcode-block" id="SampleVarianceContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SampleVarianceContainer">[docs]</a><span class="k">class</span> <span class="nc">SampleVarianceContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base container for holding the sample variance over observations.</span>

<span class="sd">    This works like :class:`ContainerBase` but provides additional capabilities</span>
<span class="sd">    for containers that may be used to hold the sample mean and variance over</span>
<span class="sd">    complex-valued observations.  These capabilities include automatic definition</span>
<span class="sd">    of the component axis, properties for accessing standard datasets, properties</span>
<span class="sd">    that rotate the sample variance into common bases, and a `sample_weight` property</span>
<span class="sd">    that provides an equivalent to the `weight` dataset that is determined from the</span>
<span class="sd">    sample variance over observations.</span>

<span class="sd">    Subclasses must include a `sample_variance` and `nsample` dataset</span>
<span class="sd">    in there `_dataset_spec` dictionary.  They must also specify a</span>
<span class="sd">    `_mean` property that returns the dataset containing the mean over observations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Set component axis to default real-imaginary basis if not already provided</span>
        <span class="k">if</span> <span class="s2">&quot;component&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="s2">&quot;imag&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;imag&quot;</span><span class="p">,</span> <span class="s2">&quot;imag&quot;</span><span class="p">)],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;component_a&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;U8&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;component_b&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;U8&quot;</span><span class="p">)],</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SampleVarianceContainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convience access to the sample variance dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        C: np.ndarray[ncomponent, ...]</span>
<span class="sd">            The variance over the dimension that was stacked</span>
<span class="sd">            (e.g., sidereal days, holographic observations)</span>
<span class="sd">            in the default real-imaginary basis. The array is packed</span>
<span class="sd">            into upper-triangle format such that the component axis</span>
<span class="sd">            contains [(&#39;real&#39;, &#39;real&#39;), (&#39;real&#39;, &#39;imag&#39;), (&#39;imag&#39;, &#39;imag&#39;)].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;sample_variance&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;sample_variance&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Dataset &#39;sample_variance&#39; not initialised.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_variance_iq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate the sample variance to the in-phase/quadrature basis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        C: np.ndarray[ncomponent, ...]</span>
<span class="sd">            The `sample_variance` dataset in the in-phase/quadrature basis,</span>
<span class="sd">            packed into upper triangle format such that the component axis</span>
<span class="sd">            contains [(&#39;I&#39;, &#39;I&#39;), (&#39;I&#39;, &#39;Q&#39;), (&#39;Q&#39;, &#39;Q&#39;)].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_variance</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="c1"># Construct rotation coefficients from average vis angle</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Rotate the covariance matrix from real-imag to in-phase/quadrature</span>
        <span class="n">Cphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">Cphi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Cphi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cs</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cc</span> <span class="o">-</span> <span class="n">ss</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cs</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Cphi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cc</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Cphi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_variance_amp_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the amplitude/phase covariance.</span>

<span class="sd">        This interpretation is only valid if the fractional</span>
<span class="sd">        variations in the amplitude and phase are small.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        C: np.ndarray[ncomponent, ...]</span>
<span class="sd">            The observed amplitude/phase covariance matrix, packed</span>
<span class="sd">            into upper triangle format such that the component axis</span>
<span class="sd">            contains [(&#39;amp&#39;, &#39;amp&#39;), (&#39;amp&#39;, &#39;phase&#39;), (&#39;phase&#39;, &#39;phase&#39;)].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rotate to in-phase/quadrature basis and then</span>
        <span class="c1"># normalize by squared amplitude to convert to</span>
        <span class="c1"># fractional units (amplitude) and radians (phase).</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_variance_iq</span> <span class="o">*</span> <span class="n">tools</span><span class="o">.</span><span class="n">invert_no_zero</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[:][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;nsample&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;nsample&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Dataset &#39;nsample&#39; not initialised.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate a weight from the sample variance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        weight: np.ndarray[...]</span>
<span class="sd">            The trace of the `sample_variance` dataset is used</span>
<span class="sd">            as an estimate of the total variance and divided by the</span>
<span class="sd">            `nsample` dataset to yield the uncertainty on the mean.</span>
<span class="sd">            The inverse of this quantity is returned, and can be compared</span>
<span class="sd">            directly to the `weight` dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_variance</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">nsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsample</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nsample</span> <span class="o">*</span> <span class="n">tools</span><span class="o">.</span><span class="n">invert_no_zero</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="FreqContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FreqContainer">[docs]</a><span class="k">class</span> <span class="nc">FreqContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pipeline container for data with a frequency axis.</span>

<span class="sd">    This works like a normal :class:`ContainerBase` container, but already has a freq</span>
<span class="sd">    axis defined, and specific properties for dealing with frequencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The physical frequency associated with each entry of the time axis.</span>

<span class="sd">        By convention this property should return the frequency in MHz at the centre</span>
<span class="sd">        of each of frequency channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">][:][</span><span class="s2">&quot;centre&quot;</span><span class="p">]</span>
        <span class="c1"># Need to check for both types as different numpy versions return</span>
        <span class="c1"># different exceptions.</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">][:]</span></div>


<div class="viewcode-block" id="SiderealContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SiderealContainer">[docs]</a><span class="k">class</span> <span class="nc">SiderealContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pipeline container for data with an RA axis.</span>

<span class="sd">    This works like a normal :class:`ContainerBase` container, but already has an RA</span>
<span class="sd">    axis defined, and specific properties for dealing with this axis.</span>

<span class="sd">    Note that Right Ascension is a fairly ambiguous term. What is typically meant</span>
<span class="sd">    here is the Local Stellar Angle, which is the transiting RA in CIRS coordinates.</span>
<span class="sd">    This is similar to J2000/ICRS with the minimal amount of coordinate rotation to</span>
<span class="sd">    account for the polar axis precession.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra : array or int, optional</span>
<span class="sd">        Either the explicit locations of samples of the RA axis, or if passed an</span>
<span class="sd">        integer interpret this as a number of samples dividing the full sidereal day</span>
<span class="sd">        and create an axis accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Allow the passing of a number of samples for the RA axis</span>
        <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">360.0</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The RA in degrees associated with each sample of the RA axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">][:]</span></div>


<div class="viewcode-block" id="MContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.MContainer">[docs]</a><span class="k">class</span> <span class="nc">MContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for holding m-mode type data.</span>

<span class="sd">    Note this container will have an `msign` axis even though not all m-mode based</span>
<span class="sd">    data needs one. As always this is not an issue, datasets that don&#39;t need it are</span>
<span class="sd">    not required to list it in their `axes` list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mmax : integer, optional</span>
<span class="sd">        Largest m to be held.</span>
<span class="sd">    oddra : bool, optional</span>
<span class="sd">        Does this MContainer come from an underlying odd number of RA points. This</span>
<span class="sd">        determines if the largest negative m is filled or not (it is for odd=True, not</span>
<span class="sd">        for odd=False). Default is odd=False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;msign&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">oddra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="c1"># Set up axes from passed arguments</span>
        <span class="k">if</span> <span class="n">mmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmax</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Ensure the sign axis is set correctly</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;msign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">])</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Set oddra, prioritising an explicit keyword argument over anything else</span>
        <span class="k">if</span> <span class="n">oddra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;oddra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oddra</span>
        <span class="k">elif</span> <span class="s2">&quot;oddra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;oddra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mmax</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The maximum m stored.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oddra</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether this represents an odd or even number of RA points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;oddra&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HealpixContainer"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.HealpixContainer">[docs]</a><span class="k">class</span> <span class="nc">HealpixContainer</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class container for holding Healpix map data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nside : int</span>
<span class="sd">        The nside of the Healpix maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pixel&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Set up axes from passed arguments</span>
        <span class="k">if</span> <span class="n">nside</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pixel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">nside</span><span class="o">**</span><span class="mi">2</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nside</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pixel&quot;</span><span class="p">])</span> <span class="o">//</span> <span class="mi">12</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="Map"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.Map">[docs]</a><span class="k">class</span> <span class="nc">Map</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">HealpixContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for holding multifrequency sky maps.</span>

<span class="sd">    The maps are packed in format `[freq, pol, pixel]` where the polarisations</span>
<span class="sd">    are Stokes I, Q, U and V, and the pixel dimension stores a Healpix map.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nside : int</span>
<span class="sd">        The nside of the Healpix maps.</span>
<span class="sd">    polarisation : bool, optional</span>
<span class="sd">        If `True` all Stokes parameters are stored, if `False` only Stokes I is</span>
<span class="sd">        stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polarisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Set up axes from passed arguments</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">polarisation</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;map&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SiderealStream"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SiderealStream">[docs]</a><span class="k">class</span> <span class="nc">SiderealStream</span><span class="p">(</span>
    <span class="n">FreqContainer</span><span class="p">,</span> <span class="n">VisContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">,</span> <span class="n">SampleVarianceContainer</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for holding a visibility dataset in sidereal time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra : int</span>
<span class="sd">        The number of points to divide the RA axis up into.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;weight_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;vis_weight&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;input_flags&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;sample_variance&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;nsample&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;input_flags&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SystemSensitivity"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SystemSensitivity">[docs]</a><span class="k">class</span> <span class="nc">SystemSensitivity</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">TODContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for holding the total system sensitivity.</span>

<span class="sd">    This should be averaged/collapsed in the stack/prod axis</span>
<span class="sd">    to provide an overall summary of the system sensitivity.</span>
<span class="sd">    Two datasets are available: the measured noise from the</span>
<span class="sd">    visibility weights and the radiometric estimate of the</span>
<span class="sd">    noise from the autocorrelations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;measured&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;radiometer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;frac_lost&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measured</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;measured&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">radiometer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;radiometer&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frac_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;frac_lost&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="RFIMask"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.RFIMask">[docs]</a><span class="k">class</span> <span class="nc">RFIMask</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">TODContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for holding RFI mask.</span>

<span class="sd">    The mask is `True` for contaminated samples that should be excluded, and</span>
<span class="sd">    `False` for clean samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SiderealRFIMask"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SiderealRFIMask">[docs]</a><span class="k">class</span> <span class="nc">SiderealRFIMask</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for holding RFI mask.</span>

<span class="sd">    The mask is `True` for contaminated samples that should be excluded, and</span>
<span class="sd">    `False` for clean samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="TimeStream"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.TimeStream">[docs]</a><span class="k">class</span> <span class="nc">TimeStream</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">VisContainer</span><span class="p">,</span> <span class="n">TODContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for holding a visibility dataset in time.</span>

<span class="sd">    This should look similar enough to the CHIME</span>
<span class="sd">    :class:`~ch_util.andata.CorrData` container that they can be used</span>
<span class="sd">    interchangably in most cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;weight_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;vis_weight&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;input_flags&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;input_flags&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="GridBeam"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.GridBeam">[docs]</a><span class="k">class</span> <span class="nc">GridBeam</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic container for representing a 2D beam on a rectangular grid.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="s2">&quot;celestial&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GridBeam</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HEALPixBeam"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.HEALPixBeam">[docs]</a><span class="k">class</span> <span class="nc">HEALPixBeam</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">HealpixContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for representing the spherical 2-d beam in a HEALPix grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ordering : {&quot;nested&quot;, &quot;ring&quot;}</span>
<span class="sd">        The HEALPix ordering scheme used for the beam map.</span>
<span class="sd">    coords : {&quot;celestial&quot;, &quot;galactic&quot;, &quot;telescope&quot;}</span>
<span class="sd">        The coordinate system that the beam map is defined on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;Et&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Ep&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)],</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pixel&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;Et&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Ep&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HEALPixBeam</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ordering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ordering</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;ordering&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nside</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pixel&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">12</span><span class="p">))</span></div>


<div class="viewcode-block" id="TrackBeam"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.TrackBeam">[docs]</a><span class="k">class</span> <span class="nc">TrackBeam</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SampleVarianceContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a sequence of beam samples at arbitrary locations on the sphere.</span>

<span class="sd">    The axis of the beam samples is &#39;pix&#39;, defined by the numpy.dtype</span>
<span class="sd">    [(&#39;theta&#39;, np.float32), (&#39;phi&#39;, np.float32)].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;weight_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;sample_variance&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;nsample&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="s2">&quot;celestial&quot;</span><span class="p">,</span>
        <span class="n">track_type</span><span class="o">=</span><span class="s2">&quot;drift&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;theta and phi axes must have same length: &quot;</span>
                    <span class="s2">&quot;(</span><span class="si">{:d}</span><span class="s2"> != </span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">pix</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span>
                <span class="n">pix</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Both theta and phi coordinates must be specified.&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TrackBeam</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;track_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;track_type&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pix&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MModes"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.MModes">[docs]</a><span class="k">class</span> <span class="nc">MModes</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">VisContainer</span><span class="p">,</span> <span class="n">MContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding m-mode data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    vis : mpidataset.MPIArray</span>
<span class="sd">        Visibility array.</span>
<span class="sd">    weight : mpidataset.MPIArray</span>
<span class="sd">        Array of weights for each point.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;msign&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;msign&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="SVDModes"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SVDModes">[docs]</a><span class="k">class</span> <span class="nc">SVDModes</span><span class="p">(</span><span class="n">MContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding SVD m-mode data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mmax : integer, optional</span>
<span class="sd">        Largest m to be held.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    vis : mpidataset.MPIArray</span>
<span class="sd">        Visibility array.</span>
<span class="sd">    weight : mpidataset.MPIArray</span>
<span class="sd">        Array of weights for each point.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;nmode&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;nmode&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis_weight&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="KLModes"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.KLModes">[docs]</a><span class="k">class</span> <span class="nc">KLModes</span><span class="p">(</span><span class="n">SVDModes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding KL filtered m-mode data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mmax : integer, optional</span>
<span class="sd">        Largest m to be held.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    vis : mpidataset.MPIArray</span>
<span class="sd">        Visibility array.</span>
<span class="sd">    weight : mpidataset.MPIArray</span>
<span class="sd">        Array of weights for each point.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="VisGridStream"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.VisGridStream">[docs]</a><span class="k">class</span> <span class="nc">VisGridStream</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibilities gridded into a 2D array.</span>

<span class="sd">    Only makes sense for an array which is a cartesian grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;weight_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;redundancy&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis_weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">redundancy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;redundancy&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HybridVisStream"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.HybridVisStream">[docs]</a><span class="k">class</span> <span class="nc">HybridVisStream</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibilities beamformed only in the NS direction.</span>

<span class="sd">    This container has visibilities beam formed only in the NS direction to give a</span>
<span class="sd">    grid in elevation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;dirty_beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis_weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This isn&#39;t useful at this stage, but it&#39;s needed to propagate onward.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;dirty_beam&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HybridVisMModes"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.HybridVisMModes">[docs]</a><span class="k">class</span> <span class="nc">HybridVisMModes</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">MContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibilities beamformed in the NS direction and m-mode transformed in RA.</span>

<span class="sd">    This container has visibilities beam formed only in the NS direction to give a</span>
<span class="sd">    grid in elevation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;msign&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;vis_weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;msign&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ew&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;vis_weight&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="RingMap"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.RingMap">[docs]</a><span class="k">class</span> <span class="nc">RingMap</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for holding multifrequency ring maps.</span>

<span class="sd">    The maps are packed in format `[freq, pol, ra, EW beam, el]` where</span>
<span class="sd">    the polarisations are Stokes I, Q, U and V.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nside : int</span>
<span class="sd">        The nside of the Healpix maps.</span>
<span class="sd">    polarisation : bool, optional</span>
<span class="sd">        If `True` all Stokes parameters are stored, if `False` only Stokes I is</span>
<span class="sd">        stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;weight_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;dirty_beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;rms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="s2">&quot;compression_opts&quot;</span><span class="p">:</span> <span class="n">COMPRESSION_OPTS</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">el</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;el&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;map&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;dirty_beam&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="RingMapMask"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.RingMapMask">[docs]</a><span class="k">class</span> <span class="nc">RingMapMask</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mask bad ringmap pixels.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="CommonModeGainData"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.CommonModeGainData">[docs]</a><span class="k">class</span> <span class="nc">CommonModeGainData</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">TODContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding gain data common to all inputs.&quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CommonModeSiderealGainData"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.CommonModeSiderealGainData">[docs]</a><span class="k">class</span> <span class="nc">CommonModeSiderealGainData</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding sidereal gain data common to all inputs.&quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="GainData"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.GainData">[docs]</a><span class="k">class</span> <span class="nc">GainData</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">TODContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding gain data.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SiderealGainData"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SiderealGainData">[docs]</a><span class="k">class</span> <span class="nc">SiderealGainData</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">,</span> <span class="n">SiderealContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding sidereal gain data.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="StaticGainData"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.StaticGainData">[docs]</a><span class="k">class</span> <span class="nc">StaticGainData</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parallel container for holding static gain data (i.e. non time varying).&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gain&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;gain&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="DelayCutoff"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.DelayCutoff">[docs]</a><span class="k">class</span> <span class="nc">DelayCutoff</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a delay cutoff.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;el&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;el&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;cutoff&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">el</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;el&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="DelaySpectrum"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.DelaySpectrum">[docs]</a><span class="k">class</span> <span class="nc">DelaySpectrum</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a delay spectrum.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;delay&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;delay&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;baseline&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Powerspectrum2D"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.Powerspectrum2D">[docs]</a><span class="k">class</span> <span class="nc">Powerspectrum2D</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a 2D cartesian power spectrum.</span>

<span class="sd">    Generally you should set the standard attributes `z_start` and `z_end` with</span>
<span class="sd">    the redshift range included in the power spectrum estimate, and the `type`</span>
<span class="sd">    attribute with a description of the estimator type. Suggested valued for</span>
<span class="sd">    `type` are:</span>

<span class="sd">    `unwindowed`</span>
<span class="sd">        The standard unbiased quadratic estimator.</span>

<span class="sd">    `minimum_variance`</span>
<span class="sd">        The minimum variance, but highly correlated, estimator. Just a rescaled</span>
<span class="sd">        version of the q-estimator.</span>

<span class="sd">    `uncorrelated`</span>
<span class="sd">        The uncorrelated estimator using the root of the Fisher matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kpar_edges, kperp_edges : np.ndarray</span>
<span class="sd">        Array of the power spectrum bin boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;kperp&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;powerspectrum&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;kperp&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;C_inv&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;kperp&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">,</span> <span class="s2">&quot;kperp&quot;</span><span class="p">,</span> <span class="s2">&quot;kpar&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kperp_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kpar_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Construct the kperp axis from the bin edges</span>
        <span class="k">if</span> <span class="n">kperp_edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">centre</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">kperp_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">kperp_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">kperp_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">kperp_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kperp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span>
                <span class="p">[</span><span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;centre&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="c1"># Construct the kpar axis from the bin edges</span>
        <span class="k">if</span> <span class="n">kpar_edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">centre</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">kpar_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">kpar_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">kpar_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">kpar_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kpar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span>
                <span class="p">[</span><span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;centre&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Powerspectrum2D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">powerspectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;powerspectrum&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">C_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;C_inv&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SVDSpectrum"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SVDSpectrum">[docs]</a><span class="k">class</span> <span class="nc">SVDSpectrum</span><span class="p">(</span><span class="n">ContainerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for an m-mode SVD spectrum.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;singularvalue&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;singularvalue&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FrequencyStack"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FrequencyStack">[docs]</a><span class="k">class</span> <span class="nc">FrequencyStack</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a frequency stack.</span>

<span class="sd">    In general used to hold the product of `draco.analysis.SourceStack`</span>
<span class="sd">    The stacked signal of frequency slices of the data in the direction</span>
<span class="sd">    of sources of interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stack&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FrequencyStackByPol"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FrequencyStackByPol">[docs]</a><span class="k">class</span> <span class="nc">FrequencyStackByPol</span><span class="p">(</span><span class="n">FrequencyStack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a frequency stack split by polarisation.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stack&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MockFrequencyStack"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.MockFrequencyStack">[docs]</a><span class="k">class</span> <span class="nc">MockFrequencyStack</span><span class="p">(</span><span class="n">FrequencyStack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for holding a frequency stack for multiple mock catalogs.</span>

<span class="sd">    Adds a `mock` axis as the first dimension of each dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mock&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stack&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mock&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mock&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="MockFrequencyStackByPol"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.MockFrequencyStackByPol">[docs]</a><span class="k">class</span> <span class="nc">MockFrequencyStackByPol</span><span class="p">(</span><span class="n">FrequencyStackByPol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for holding a frequency stack split by pol for multiple mock catalogs.</span>

<span class="sd">    Adds a `mock` axis as the first dimension of each dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mock&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stack&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mock&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mock&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="Stack3D"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.Stack3D">[docs]</a><span class="k">class</span> <span class="nc">Stack3D</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for a 3D frequency stack.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_ra&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_dec&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stack&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_ra&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_dec&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_ra&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_dec&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SourceCatalog"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SourceCatalog">[docs]</a><span class="k">class</span> <span class="nc">SourceCatalog</span><span class="p">(</span><span class="n">TableBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A basic container for holding astronomical source catalogs.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The `ra` and `dec` coordinates should be ICRS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_table_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="s2">&quot;axis&quot;</span><span class="p">:</span> <span class="s2">&quot;object_id&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="SpectroscopicCatalog"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.SpectroscopicCatalog">[docs]</a><span class="k">class</span> <span class="nc">SpectroscopicCatalog</span><span class="p">(</span><span class="n">SourceCatalog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for spectroscopic catalogs.&quot;&quot;&quot;</span>

    <span class="n">_table_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;redshift&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;z_error&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="s2">&quot;axis&quot;</span><span class="p">:</span> <span class="s2">&quot;object_id&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="FormedBeam"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FormedBeam">[docs]</a><span class="k">class</span> <span class="nc">FormedBeam</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for formed beams.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)]),</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;redshift&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;z_error&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)]),</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: is this necessary</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FormedBeamHA"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FormedBeamHA">[docs]</a><span class="k">class</span> <span class="nc">FormedBeamHA</span><span class="p">(</span><span class="n">FormedBeam</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container for formed beams.</span>
<span class="sd">    These have not been collapsed in the hour angle (HA) axis</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ha&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;beam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;object_ha&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;object_ha&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FormedBeamMask"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FormedBeamMask">[docs]</a><span class="k">class</span> <span class="nc">FormedBeamMask</span><span class="p">(</span><span class="n">FreqContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mask bad formed beams.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FormedBeamHAMask"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.FormedBeamHAMask">[docs]</a><span class="k">class</span> <span class="nc">FormedBeamHAMask</span><span class="p">(</span><span class="n">FormedBeamMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mask bad formed beams as a function of hour angle.&quot;&quot;&quot;</span>

    <span class="n">_axes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ha&quot;</span><span class="p">,)</span>

    <span class="n">_dataset_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pol&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;initialise&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;distributed_axis&quot;</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="empty_like"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.empty_like">[docs]</a><span class="k">def</span> <span class="nf">empty_like</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an empty container like `obj`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : ContainerBase</span>
<span class="sd">        Container to base this one off.</span>
<span class="sd">    kwargs : optional</span>
<span class="sd">        Optional definitions of specific axes we want to override. Works in the</span>
<span class="sd">        same way as the `ContainerBase` constructor, though `axes_from=obj` and</span>
<span class="sd">        `attrs_from=obj` are implied.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    newobj : container.ContainerBase</span>
<span class="sd">        New data container.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ContainerBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">axes_from</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs_from</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;I don&#39;t know how to deal with data type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="empty_timestream"><a class="viewcode-back" href="../../../_autosummary/draco.core.containers.html#draco.core.containers.empty_timestream">[docs]</a><span class="k">def</span> <span class="nf">empty_timestream</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new timestream container.</span>

<span class="sd">    This indirect call exists so it can be replaced to return custom timestream</span>
<span class="sd">    types.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kwargs : optional</span>
<span class="sd">        Arguments to pass to the timestream constructor.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts : TimeStream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TimeStream</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Richard Shaw.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>